/**
 * @addtogroup	libMU_Display
 * Library for graphical and text manipulation of OLED display (font definition)
 * @{
 ********************************************************************
 * @author		Eñaut Muxika <emuxika at mondragon dot edu>
 * @date		2011/7/10
 * @copyright	BSDL
 ********************************************************************
 */
#include <libMU/display.h>
#include <libMU/utf.h>

/**
 * A 5x7 font (in a 6x8 cell, where the sixth column is omitted from this
 * table) for displaying text on the OLED display.  The data is organized as
 * bytes from the left column to the right column, with each byte containing
 * the top row in the LSB and the bottom row in the MSB.
 *
 * Note:  The single bit-per-pixel is expanded in the DrawString
 * function to the appropriate four bit-per-pixel gray scale format.
 */
static const uint8_t libMU_Display_Font[256][5] =
{
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x00 */
    { 0x3e, 0x45, 0x51, 0x45, 0x3e }, /* 0x01 */
    { 0x3e, 0x7b, 0x6f, 0x7b, 0x3e }, /* 0x02 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x03 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x04 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x05 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x06 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x07 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x08 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x09 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x0a */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x0b */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x0c */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x0d */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x0e */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x0f */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x10 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x11 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x12 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x13 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x14 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x15 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x16 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x17 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x18 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x19 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x1a */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x1b */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x1c */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x1d */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x1e */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x1f */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* " " */
    { 0x00, 0x00, 0x4f, 0x00, 0x00 }, /* ! */
    { 0x00, 0x07, 0x00, 0x07, 0x00 }, /* " */
    { 0x14, 0x7f, 0x14, 0x7f, 0x14 }, /* # */
    { 0x24, 0x2a, 0x7f, 0x2a, 0x12 }, /* $ */
    { 0x23, 0x13, 0x08, 0x64, 0x62 }, /* % */
    { 0x36, 0x49, 0x55, 0x22, 0x50 }, /* & */
    { 0x00, 0x05, 0x03, 0x00, 0x00 }, /* ' */
    { 0x00, 0x1c, 0x22, 0x41, 0x00 }, /* ( */
    { 0x00, 0x41, 0x22, 0x1c, 0x00 }, /* ) */
    { 0x14, 0x08, 0x3e, 0x08, 0x14 }, /* * */
    { 0x08, 0x08, 0x3e, 0x08, 0x08 }, /* + */
    { 0x00, 0x50, 0x30, 0x00, 0x00 }, /* , */
    { 0x08, 0x08, 0x08, 0x08, 0x08 }, /* - */
    { 0x00, 0x60, 0x60, 0x00, 0x00 }, /* . */
    { 0x20, 0x10, 0x08, 0x04, 0x02 }, /* / */
    { 0x3e, 0x51, 0x49, 0x45, 0x3e }, /* 0 */
    { 0x00, 0x42, 0x7f, 0x40, 0x00 }, /* 1 */
    { 0x42, 0x61, 0x51, 0x49, 0x46 }, /* 2 */
    { 0x21, 0x41, 0x45, 0x4b, 0x31 }, /* 3 */
    { 0x18, 0x14, 0x12, 0x7f, 0x10 }, /* 4 */
    { 0x27, 0x45, 0x45, 0x45, 0x39 }, /* 5 */
    { 0x3c, 0x4a, 0x49, 0x49, 0x30 }, /* 6 */
    { 0x01, 0x71, 0x09, 0x05, 0x03 }, /* 7 */
    { 0x36, 0x49, 0x49, 0x49, 0x36 }, /* 8 */
    { 0x06, 0x49, 0x49, 0x29, 0x1e }, /* 9 */
    { 0x00, 0x36, 0x36, 0x00, 0x00 }, /* : */
    { 0x00, 0x56, 0x36, 0x00, 0x00 }, /* ; */
    { 0x08, 0x14, 0x22, 0x41, 0x00 }, /* < */
    { 0x14, 0x14, 0x14, 0x14, 0x14 }, /* = */
    { 0x00, 0x41, 0x22, 0x14, 0x08 }, /* > */
    { 0x02, 0x01, 0x51, 0x09, 0x06 }, /* ? */
    { 0x32, 0x49, 0x79, 0x41, 0x3e }, /* @ */
    { 0x7e, 0x11, 0x11, 0x11, 0x7e }, /* A */
    { 0x7f, 0x49, 0x49, 0x49, 0x36 }, /* B */
    { 0x3e, 0x41, 0x41, 0x41, 0x22 }, /* C */
    { 0x7f, 0x41, 0x41, 0x22, 0x1c }, /* D */
    { 0x7f, 0x49, 0x49, 0x49, 0x41 }, /* E */
    { 0x7f, 0x09, 0x09, 0x09, 0x01 }, /* F */
    { 0x3e, 0x41, 0x49, 0x49, 0x7a }, /* G */
    { 0x7f, 0x08, 0x08, 0x08, 0x7f }, /* H */
    { 0x00, 0x41, 0x7f, 0x41, 0x00 }, /* I */
    { 0x20, 0x40, 0x41, 0x3f, 0x01 }, /* J */
    { 0x7f, 0x08, 0x14, 0x22, 0x41 }, /* K */
    { 0x7f, 0x40, 0x40, 0x40, 0x40 }, /* L */
    { 0x7f, 0x02, 0x0c, 0x02, 0x7f }, /* M */
    { 0x7f, 0x04, 0x08, 0x10, 0x7f }, /* N */
    { 0x3e, 0x41, 0x41, 0x41, 0x3e }, /* O */
    { 0x7f, 0x09, 0x09, 0x09, 0x06 }, /* P */
    { 0x3e, 0x41, 0x51, 0x21, 0x5e }, /* Q */
    { 0x7f, 0x09, 0x19, 0x29, 0x46 }, /* R */
    { 0x46, 0x49, 0x49, 0x49, 0x31 }, /* S */
    { 0x01, 0x01, 0x7f, 0x01, 0x01 }, /* T */
    { 0x3f, 0x40, 0x40, 0x40, 0x3f }, /* U */
    { 0x1f, 0x20, 0x40, 0x20, 0x1f }, /* V */
    { 0x3f, 0x40, 0x38, 0x40, 0x3f }, /* W */
    { 0x63, 0x14, 0x08, 0x14, 0x63 }, /* X */
    { 0x07, 0x08, 0x70, 0x08, 0x07 }, /* Y */
    { 0x61, 0x51, 0x49, 0x45, 0x43 }, /* Z */
    { 0x00, 0x7f, 0x41, 0x41, 0x00 }, /* [ */
    { 0x02, 0x04, 0x08, 0x10, 0x20 }, /* "\" */
    { 0x00, 0x41, 0x41, 0x7f, 0x00 }, /* ] */
    { 0x04, 0x02, 0x01, 0x02, 0x04 }, /* ^ */
    { 0x40, 0x40, 0x40, 0x40, 0x40 }, /* _ */
    { 0x00, 0x01, 0x02, 0x04, 0x00 }, /* ` */
    { 0x20, 0x54, 0x54, 0x54, 0x78 }, /* a */
    { 0x7f, 0x48, 0x44, 0x44, 0x38 }, /* b */
    { 0x38, 0x44, 0x44, 0x44, 0x20 }, /* c */
    { 0x38, 0x44, 0x44, 0x48, 0x7f }, /* d */
    { 0x38, 0x54, 0x54, 0x54, 0x18 }, /* e */
    { 0x08, 0x7e, 0x09, 0x01, 0x02 }, /* f */
    { 0x0c, 0x52, 0x52, 0x52, 0x3e }, /* g */
    { 0x7f, 0x08, 0x04, 0x04, 0x78 }, /* h */
    { 0x00, 0x44, 0x7d, 0x40, 0x00 }, /* i */
    { 0x20, 0x40, 0x44, 0x3d, 0x00 }, /* j */
    { 0x7f, 0x10, 0x28, 0x44, 0x00 }, /* k */
    { 0x00, 0x41, 0x7f, 0x40, 0x00 }, /* l */
    { 0x7c, 0x04, 0x18, 0x04, 0x78 }, /* m */
    { 0x7c, 0x08, 0x04, 0x04, 0x78 }, /* n */
    { 0x38, 0x44, 0x44, 0x44, 0x38 }, /* o */
    { 0x7c, 0x14, 0x14, 0x14, 0x08 }, /* p */
    { 0x08, 0x14, 0x14, 0x18, 0x7c }, /* q */
    { 0x7c, 0x08, 0x04, 0x04, 0x08 }, /* r */
    { 0x48, 0x54, 0x54, 0x54, 0x20 }, /* s */
    { 0x04, 0x3f, 0x44, 0x40, 0x20 }, /* t */
    { 0x3c, 0x40, 0x40, 0x20, 0x7c }, /* u */
    { 0x1c, 0x20, 0x40, 0x20, 0x1c }, /* v */
    { 0x3c, 0x40, 0x30, 0x40, 0x3c }, /* w */
    { 0x44, 0x28, 0x10, 0x28, 0x44 }, /* x */
    { 0x0c, 0x50, 0x50, 0x50, 0x3c }, /* y */
    { 0x44, 0x64, 0x54, 0x4c, 0x44 }, /* z */
    { 0x00, 0x08, 0x36, 0x41, 0x00 }, /* { */
    { 0x00, 0x00, 0x7f, 0x00, 0x00 }, /* | */
    { 0x00, 0x41, 0x36, 0x08, 0x00 }, /* } */
    { 0x02, 0x01, 0x02, 0x04, 0x02 }, /* ~ */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x7F */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x80 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x81 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x82 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x83 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x84 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x85 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x86 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x87 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x88 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x89 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x8a */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x8b */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x8c */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x8d */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x8e */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x8f */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x90 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x91 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x92 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x93 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x94 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x95 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x96 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x97 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x98 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x99 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x9a */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x9b */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x9c */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x9d */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x9e */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0x9f */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa0 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa1 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa2 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa3 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa4 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa5 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa6 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa7 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa8 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xa9 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xaa */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xab */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xac */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xad */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xae */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xaf */

    { 0x00, 0x02, 0x05, 0x02, 0x00 }, /* 0xb0, ° */
    { 0x44, 0x44, 0x5f, 0x44, 0x44 }, /* 0xb1, ± */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb2 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb3 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb4 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb5 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb6 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb7 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb8 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xb9 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xba */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xbb */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xbc */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xbd */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xbe */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xbf */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc0 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc1 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc2 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc3 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc4 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc5 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc6 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc7 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc8 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xc9 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xca */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xcb */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xcc */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xcd */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xce */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xcf */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd0 */
    { 0x7d, 0x05, 0x09, 0x11, 0x7d }, /* 0xd1, Ñ */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd2 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd3 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd4 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd5 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd6 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd7 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd8 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xd9 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xda */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xdb */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xdc */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xdd */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xde */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xdf */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe0 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe1 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe2 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe3 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe4 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe5 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe6 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe7 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe8 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xe9 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xea */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xeb */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xec */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xed */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xee */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xef */

    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf0 */
    { 0x7c, 0x09, 0x05, 0x05, 0x79 }, /* 0xf1, ñ */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf2 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf3 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf4 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf5 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf6 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf7 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf8 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xf9 */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xfa */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xfb */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xfc */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xfd */
    { 0x00, 0x00, 0x00, 0x00, 0x00 }, /* 0xfe */
    { 0x0c, 0x51, 0x50, 0x51, 0x3c }, /* 0xff, ÿ */
};

/**
 * Constants used in character rendering
 */
#define	VP_MIN_X			0
#define	VP_MAX_X			libMU_Display_RES_X
#define	VP_MIN_Y			0
#define	VP_MAX_Y			libMU_Display_RES_Y
#define	CHAR_WIDTH			libMU_Display_CHAR_WIDTH
#define	CHAR_WIDTH_ARR		(libMU_Display_CHAR_WIDTH-1)
#define	CHAR_WIDTH_B		((libMU_Display_CHAR_WIDTH*libMU_Display_BPP+4)/8)
#define CHAR_HEIGHT			libMU_Display_CHAR_HEIGHT
#define CHAR_WIDTH_MASK		((1u<<CHAR_WIDTH) - 1u)
#define CHAR_HEIGHT_MASK	((1u<<CHAR_HEIGHT) - 1u)
#if defined(DEBUG)
static uint32_t				charCheck1 = 0x12345678;
static uint8_t				charBuffer[CHAR_WIDTH_B * CHAR_HEIGHT];
static uint32_t				charCheck2 = 0x87654321;
#endif

/**
 * Draw a UTF8 text in the display (limited to codepoints 0-0xFF)
 * @param text		Text to show
 * @param pos_X		Horizontal position of text in pixels (lower than 128 and even)
 * @param pos_Y		Vertical position of text in pixels (lower than 96)
 * @param intensity	Color intensity (grayscale from 0 to 15)
 * @note			UTF8 support is limited to ASCII plus 4 other codepoints at the moment
 */
void libMU_Display_DrawStringUTF8(const char *text, int pos_X, int pos_Y, int intensity)
{
#if !defined(DEBUG)
	uint8_t				charBuffer[CHAR_WIDTH_B * CHAR_HEIGHT];
#endif
	uint32_t ch; unsigned int len;
	int rX, rY, width, height, written;
	uint8_t mask_row, pixel_value;
	int row, row_s, row_e;
	int col, col_s, col_e;
	uint8_t* buf;
	intensity &= 0x0F;
	while( *text ) {
		if( *text == '\r' ) { pos_X = 0; text++; continue; }
		if( *text == '\n' ) {
			pos_X = VP_MIN_X; pos_Y += CHAR_HEIGHT; text++; continue;
		}
		/* See if character is visible */
		if( pos_Y >= VP_MAX_Y ) return;	/* no more space, return */
		if( pos_Y <= VP_MIN_Y - CHAR_HEIGHT + 1) {
			text++; continue;	/* Still not in display, see if we skip to next line */
		}
		if( pos_X >= VP_MAX_X ) {
			text++; continue;/* no more space in line, see if we skip to next line */
		}
		if( pos_X <= VP_MIN_X - CHAR_WIDTH + 1) {
			/* Not still visible in display, continue */
			pos_X += CHAR_WIDTH; text++; continue;
		}
		/* Character at least partially visible, get UTF32 codepoint */
		ch = utf8_to_utf32_char( (const uint8_t*)text, &len );
		if( len == 0 ) return; /* Incorrectly formed utf8 string */
		text += len;
		if( ch > 0xFF ) ch = ' ';
		/* Get visible portion information for character */
		if( pos_X >= VP_MIN_X ) {
			rX = pos_X; col_s = 0;
			width = VP_MAX_X - pos_X;
			if( width>= CHAR_WIDTH_ARR )
				width = CHAR_WIDTH_ARR;
		}else{
			rX = VP_MIN_X; col_s = rX - pos_X;
			width = pos_X + CHAR_WIDTH_ARR - VP_MIN_X;
		}
		col_e = col_s + width;
		if( pos_Y >= VP_MIN_Y ) {
			rY = pos_Y; row_s = 0;
			height = VP_MAX_Y - pos_Y;
			if( height>= CHAR_HEIGHT )
				height = CHAR_HEIGHT;
		}else{
			rY = VP_MIN_Y; row_s = rY - pos_Y;
			height = pos_Y + CHAR_HEIGHT - VP_MIN_Y;
		}
		row_e = row_s + height;
		buf = charBuffer;
		/* Get character bitmap */
		mask_row = (1 << row_s);
		for( row = row_s; row < row_e; row++, mask_row <<= 1 ) {
			pixel_value = 0; written = 1;
			for( col = col_s; col < col_e; col++ ) {
				/* Convert 1BPP char representation to 4BPP representation */
				written = 0;
				if( (libMU_Display_Font[ch][col] & mask_row) ) {
					pixel_value |= intensity;
				}
				if( (pos_X + col) & 1 ) { /* Write only when 2 pixel information is ready */
					written = 1;
					*buf++ = pixel_value;
				}
				pixel_value <<= 4;
			}
			if( !written && ((pos_X + col) & 1) ) /* Write only when 2 pixel information is ready */
				*buf++ = pixel_value;
		}
#if defined(DEBUG)
		/* Check for memory overruns */
		while( charCheck2 != 0x87654321 || charCheck1 != 0x12345678 ) {}
#endif
		/* Show character */
		RIT128x96x4ImageDraw( charBuffer, rX & ~1,  rY, (width + 1) & ~1, height );
		/* Update position */
		pos_X += CHAR_WIDTH;
	}
}

/**
 * @}
 */
